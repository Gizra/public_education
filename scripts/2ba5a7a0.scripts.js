"use strict";angular.module("publicEducationApp",["config","angular-audio-player","angularLocalStorage","leaflet-directive"]).config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"ListMarkersCtrl"}).when("/add-marker",{templateUrl:"views/add-marker.html",controller:"AddMarkerCtrl"}).when("/play-marker/:venueId",{templateUrl:"views/play-marker.html",controller:"PlayMarkerCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"loginCtrl"}).otherwise({redirectTo:"/"}),delete b.defaults.headers.common["X-Requested-With"]}]),angular.module("config",[]).constant("ENV","development").constant("FOURSQUARE",{id:"IZPZNXG2P5A3H4EBIFFEMRAIBMXCNGM1ZZ2QUPN2D1WNKNGX",secret:"MZ0CZ4Z0PMAEAGKDPJ5DO0BI2M1FAMJXRGWMCWNCPC5MQ02U"}).constant("BACKEND_URL","http://localhost:3000"),angular.module("publicEducationApp").controller("ListMarkersCtrl",["$scope","Leaflet","storage","Marker","$location",function(a,b,c,d,e){angular.extend(a,b.getDefaults()),c.bind(a,"center",{defaultValue:b.getCenter()}),a.markers={},d.gettingMarkers().then(function(b){var c;angular.forEach(b,function(b,d){c=0,angular.forEach(b.playList,function(a){a.unprocessed||++c}),b.icon=L.divIcon({iconSize:[10,10],html:c,iconAnchor:[0,0]}),console.log(d),a.markers[d]=b})}),angular.forEach(["zoomend","moveend"],function(c){a.$on("leafletDirectiveMap."+c,function(){b.setCenter(a.center)})}),a.$on("leafletDirectiveMarker.click",function(a,b){e.path("/play-marker/"+b.markerName)})}]),angular.module("publicEducationApp").controller("AddMarkerCtrl",["$scope","$location","Leaflet","Foursquare","storage","User","Marker",function(a,b,c,d,e,f,g){var h=function(){if(a.center.zoom>=16){var b=a.center.lat,c=a.center.lng;a.markers={marker:{lat:b,lng:c,draggable:!0,venue:null}},d.gettingVenue(b,c).then(function(b){a.markers.marker.venue=b})}else a.markers={}};angular.extend(a,c.getDefaults()),angular.forEach(["leafletDirectiveMap.zoomend","leafletDirectiveMap.moveend","leafletDirectiveMarker.dragend"],function(b){a.$on(b,function(b,d){"leafletDirectiveMarker.dragend"===b.name&&(a.center.lat=d.leafletEvent.target._latlng.lat,a.center.lng=d.leafletEvent.target._latlng.lng),h(),c.setCenter(a.center)})}),f.getUser().then(function(b){a.user=b}),a.setState=function(b){a.state=b},a.onRecorded=function(){a.setState("completed")},a.$watch("state",function(b,c){if("completed"===c)return a.onComplete();if("completed"===b){var d={id:a.markers.marker.venue.id,name:a.markers.marker.venue.name,lat:a.markers.marker.venue.location.lat,lng:a.markers.marker.venue.location.lng},e={lng:a.markers.marker.lng,lat:a.markers.marker.lat};g.addMarker(d,a.text,a.file,e,a.user).then(function(){a.onComplete()})}}),a.onComplete=function(){e.unbind(a,"state"),e.remove("text"),e.remove("state"),e.remove("markers"),e.clearAll(),b.path("/")},e.bind(a,"center",{defaultValue:c.getCenter()}),e.bind(a,"text"),e.bind(a,"markers"),e.bind(a,"state",{defaultValue:"mark"}),h()}]),angular.module("publicEducationApp").service("Leaflet",function(){return{data:{leaflet:{center:{lat:41.0383,lng:28.9869,zoom:16}},markers:{},marker:null},getDefaults:function(){return{defaults:{maxZoom:20,minZoom:14}}},getCenter:function(){return this.data.leaflet.center},setCenter:function(a){this.data.leaflet.center=a}}}),angular.module("publicEducationApp").service("Foursquare",["$http","$q","FOURSQUARE",function(a,b,c){return{gettingVenue:function(d,e){var f=b.defer();return a({method:"GET",url:"https://api.foursquare.com/v2/venues/search",params:{ll:d+","+e,v:20130917,client_id:c.id,client_secret:c.secret,limit:1},cache:!0}).success(function(a){f.resolve(a.response.venues[0])}),f.promise}}}]),angular.module("publicEducationApp").filter("venueName",function(){return function(a){return a?a:"Loading..."}}),angular.module("publicEducationApp").directive("soundRecorder",["Marker","$timeout","Phonegap",function(a,b,c){return{templateUrl:"views/sound-recorder.html",restrict:"E",scope:{file:"=file",onRecorded:"&onRecorded"},link:function(a){a.state="beforeRecord",a.file="myrecording.amr";var d=c.getMedia(a.file,function(){console.log("recordAudio():Audio Success")},function(a){console.log("code: "+a.code+"\n"+"message: "+a.message+"\n")});a.startRecord=function(){a.state="recording",d.startRecord(),a.counter=1,a.onTimeout=function(){a.counter--,a.counter>0?c=b(a.onTimeout,1e3):a.stopRecord()};var c=b(a.onTimeout,1e3)},a.stopRecord=function(){d.stopRecord(),a.state="afterRecord"},a.playRecord=function(){a.state="playRecord"}}}}]),angular.module("publicEducationApp").controller("PlayMarkerCtrl",["$scope","$routeParams","$location","Marker",function(a,b,c,d){a.venueId=b.venueId,angular.extend(a,{selectedMarker:{playList:[]}}),d.gettingMarkers().then(function(b){a.markers=b,a.markers[a.venueId]||c.path("/"),a.selectedMarker=a.markers[a.venueId]})}]),angular.module("publicEducationApp").controller("loginCtrl",["$scope","User","$location","BACKEND_URL",function(a,b,c,d){b.getUser().then(function(b){a.user=b}),a.backendUrl=d}]),angular.module("publicEducationApp").service("User",["$http","$q","BACKEND_URL",function(a,b,c){return{data:{user:null},getUser:function(){var d=b.defer();return a({method:"GET",url:c+"/account",cache:!0,withCredentials:!0}).success(function(a){d.resolve(a)}),d.promise}}}]),angular.module("publicEducationApp").service("Marker",["$q","$http","$timeout","BACKEND_URL","Phonegap",function(a,b,c,d,e){return{data:{markers:null},addMarker:function(a,b,c,d,e){var f=a.id;this.data.markers=this.data.markers||{},this.data.markers[f]||(this.data.markers[f]={name:a.name,lat:a.lat,lng:a.lng,playlist:[]});var g={};e&&(g={name:e.name,photo:e.photo});var h={src:c,text:b,user:g,unprocessed:!0,location:d};return this.data.markers[f].playList=this.data.markers[f].playList||[],this.data.markers[f].playList.unshift(h),this.uploadingMarker(h)},gettingMarkers:function(b){var d=a.defer();b=b||!0;var e;e=this.data.markers&&b?this.data.markers:{"513ee460e4b06c84bc3599d1":{name:"Topçular Semt Polikliniği",lat:41.0383,lng:28.9869,playList:[{src:"http://upload.wikimedia.org/wikipedia/en/7/79/Korn_-_Predictable_%28demo%29.ogg",text:"1st text",user:{name:"amitaibu",photo:"https://graph.facebook.com/amitai.burstein/picture"}},{src:"http://www.metadecks.org/software/sweep/audio/demos/vocal2.ogg",text:"2nd  text",user:{name:"Bruce",photo:"https://graph.facebook.com/brice.lenfant/picture"}},{src:"http://demos.w3avenue.com/html5-unleashed-tips-tricks-and-techniques/demo-audio.ogg",text:"3rd text",user:{}}]},"513ee460e4b06c84bc359988":{name:"Another place",lat:41.0396,lng:28.9842,playList:[{src:"http://upload.wikimedia.org/wikipedia/en/7/79/Korn_-_Predictable_%28demo%29.ogg",text:"1st text",user:{name:"amitaibu",photo:"https://graph.facebook.com/amitai.burstein/picture"}},{src:"http://www.metadecks.org/software/sweep/audio/demos/vocal2.ogg",text:"2nd  text",user:{name:"Bruce",photo:"https://graph.facebook.com/brice.lenfant/picture"}}]}};var f=this;return c(function(){f.data.markers=e,d.resolve(e)},500),d.promise},uploadingMarker:function(b){var c=a.defer(),f=b.src,g=e.getFileUploadOptions();g.fileKey="file",g.fileName=f.substr(f.lastIndexOf("/")+1),g.mimeType="audio/amr";var h={"Content-type":"multipart/form-data; boundary=+++++"};g.headers=h;var i=e.getFileTransfer();return i.upload(f,d+"/recordings/create",function(a){console.log("Response = "+a.response),c.resolve(a)},function(a){console.log("An error has occurred: Code = "+a.code),c.reject(a)},g),c.promise}}}]),angular.module("publicEducationApp").service("Phonegap",["$q",function(){return{getFileUploadOptions:function(){return void 0===typeof cordova?new FileUploadOptions:{}},getFileTransfer:function(){return void 0===typeof cordova?new FileTransfer:{upload:function(a,b,c){return c(!0)}}},getMedia:function(a,b,c){return void 0===typeof cordova?new Media(a,b,c):{startRecord:function(){return!0},stopRecord:function(){return!0}}}}}]);